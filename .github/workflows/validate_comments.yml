name: Build

on:
  push:
    branches:
     - release/ARQPD-41

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Get the approval comment
        id: get_comment
        run: |
          echo "comment=major">> "$GITHUB_OUTPUT"

      - name: Get issue
        id: get_issue
        run: |
          var=${{github.ref_name}}
          echo "issue=$(echo $var | sed -E 's#.*/##')">> "$GITHUB_OUTPUT"

      # Falla cuando se modifique el pom ---------------------------------------------------------------------
      - name: Generate bumping version as patch
        id: patch
        if: contains(steps.get_comment.outputs.comment, 'patch')
        run: |
          echo "Funciona"
          

      - name: Generate bumping version as minor
        id: minor
        if: contains(steps.get_comment.outputs.comment, 'minor')
        run: |
          echo "Funciona"

      - name: Generate bumping version as major
        id: major
        if: contains(steps.get_comment.outputs.comment, 'major')
        run: |
          echo "Funciona"
      # ------------------------------------------------------------------------------------------------------

      #Posible fallo
      - name: Compile the Project
        id: compile
        run: |
          echo "Funciona"

      #Posible fallo
      - name: Build with Maven
        id: package
        run: |
          ./error.sh

      #Posible fallo
      - name: Build and push
        id: kaniko
        run: |
          ./error.sh

      - name: Configure message notification
        if: success() || failure()
        id: get_comment_jira
        run: |
          declare -A ejecuciones
          
          ejecuciones["patch"]="${{ steps.patch.conclusion}}"
          ejecuciones["minor"]="${{ steps.minor.conclusion}}"
          ejecuciones["major"]="${{ steps.major.conclusion}}"
          ejecuciones["compilar"]="${{ steps.compile.conclusion}}"
          ejecuciones["empaquetar"]="${{ steps.package.conclusion}}"
          ejecuciones["kaniko"]="${{ steps.kaniko.conclusion}}" 
          
          var=$"Empaquetado exitoso, se cargo la imagen en Harbor de manera correcta"
          
          for clave in "${!ejecuciones[@]}"; do
          if [[ "${ejecuciones[$clave]}" == "failure" ]]; then
            if [[ "$clave" == "patch" || "$clave" == "minor" || "$clave" == "major" ]]; then
              var=$"El tipo de version $clave no se puede generar revise el archivo pom.xml o verifique el workflow"
            elif [[ "$clave" == "compilar" || "$clave" == "empaquetar" ]]; then
              var=$"Error al $clave, por favor verifique el workflow y solucione el error"
            elif [[ "$clave" == "build"  ]]; then
              var=$"Error al crear la imagen de Kaniko, revise el workflow y de ser necesario actualice las credenciales"
            fi
          fi
          done
          echo "comment=$var" >> "$GITHUB_OUTPUT" 

      - name: Send notification
        if: success() || failure()
        run: |
          echo "${{steps.get_comment_jira.outputs.comment}}"
          echo "${{steps.get_issue.outputs.issue}}"